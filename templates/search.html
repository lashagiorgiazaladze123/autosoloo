{% extends 'base.html' %}

{% block scripts %}
{{ super() }}
<script>
let searchModelDefaultOptions = '';

document.addEventListener('DOMContentLoaded', function() {
    const makeInput = document.getElementById('make-input');
    const modelInput = document.getElementById('model-input');
    const modelDatalist = document.getElementById('model-options');

    if (modelDatalist && !searchModelDefaultOptions) {
        searchModelDefaultOptions = modelDatalist.innerHTML;
    }

    if (!makeInput || !modelInput || !modelDatalist) {
        console.error('Required elements not found:', { makeInput, modelInput, modelDatalist });
        return;
    }

    console.log('Make-model filtering initialized');

    // Store default options
    const defaultModelValues = Array.from(modelDatalist.options).map(option => option.value);

    function populateDatalist(values) {
        console.log('Populating datalist with', values.length, 'options');
        modelDatalist.innerHTML = '';
        values.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            modelDatalist.appendChild(option);
        });
    }

    function populateModels(makeValue, clearValue = true) {
        const make = (makeValue || '').trim();
        console.log('populateModels called with make:', make, 'clearValue:', clearValue);

        if (clearValue) {
            modelInput.value = '';
        }

        if (!make) {
            console.log('No make specified, showing all models');
            populateDatalist(defaultModelValues);
            modelInput.disabled = false;
            modelInput.placeholder = 'Select or type model';
            return;
        }

        modelInput.disabled = true;
        modelInput.placeholder = 'Loading modelsâ€¦';

        console.log('Fetching models for make:', make);
        fetch(`/api/get-models/${encodeURIComponent(make)}`)
            .then(response => {
                console.log('API response status:', response.status);
                return response.json();
            })
            .then(models => {
                console.log('Received models:', models);
                if (Array.isArray(models) && models.length) {
                    populateDatalist(models);
                    modelInput.placeholder = 'Select or type model';
                } else {
                    populateDatalist([]);
                    modelInput.placeholder = 'No models available';
                }

                modelInput.disabled = false;
            })
            .catch(error => {
                console.error('Failed to load models for make', make, error);
                populateDatalist(defaultModelValues);
                modelInput.disabled = false;
                modelInput.placeholder = 'Select or type model';
            });
    }

    // Listen for multiple events to ensure filtering works
    makeInput.addEventListener('input', function(e) {
        console.log('Make input event fired:', e.type, 'value:', e.target.value);
        populateModels(e.target.value, true);
    });

    makeInput.addEventListener('change', function(e) {
        console.log('Make change event fired:', e.type, 'value:', e.target.value);
        populateModels(e.target.value, true);
    });

    makeInput.addEventListener('blur', function(e) {
        console.log('Make blur event fired, value:', e.target.value);
        // Small delay to allow datalist selection to complete
        setTimeout(() => populateModels(e.target.value, false), 100);
    });

    // Also listen for when the model input is focused to ensure current make is applied
    modelInput.addEventListener('focus', function() {
        const currentMake = makeInput.value.trim();
        if (currentMake) {
            console.log('Model input focused, re-applying make filter for:', currentMake);
            populateModels(currentMake, false);
        }
    });

    // Add a click listener to the model input as well - this is what the user triggers
    modelInput.addEventListener('click', function() {
        const currentMake = makeInput.value.trim();
        if (currentMake) {
            console.log('Model input clicked, ensuring make filter is applied for:', currentMake);
            // Force immediate update
            populateModels(currentMake, false);
        }
    });

    // Add mousedown event as well for better responsiveness
    modelInput.addEventListener('mousedown', function() {
        const currentMake = makeInput.value.trim();
        if (currentMake) {
            console.log('Model input mousedown, ensuring make filter is applied for:', currentMake);
            populateModels(currentMake, false);
        }
    });

    // Monitor the make input for any changes using a mutation observer as backup
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'value') {
                const newValue = makeInput.value.trim();
                if (newValue) {
                    console.log('Make input value changed via mutation observer:', newValue);
                    populateModels(newValue, false);
                }
            }
        });
    });
    
    observer.observe(makeInput, {
        attributes: true,
        attributeFilter: ['value']
    });

    // Initialize if make already has a value
    if (makeInput.value) {
        console.log('Make has initial value:', makeInput.value);
        populateModels(makeInput.value, false);
    }
});
</script>
{% endblock %}

{% block content %}
<!-- Search Page Header -->
<div class="page-header">
    <h1>
        <i class="fas fa-search" aria-hidden="true"></i>
        Search Your Perfect Car
    </h1>
    <p>Use our advanced filters to find exactly what you're looking for</p>
</div>

<!-- Enhanced Search Form -->
<form class="search-form" method="POST" role="search">
    <div class="search-header-grid">
        <div class="search-input-wrapper">
            <label for="make-input">Make</label>
            <div class="input-with-select input-compact">
                <i class="fas fa-car search-icon" aria-hidden="true"></i>
                <input id="make-input" type="text" name="make" class="search-input compact-input" placeholder="Select or type make" list="make-options" autocomplete="off" value="{{ selected_filters.make or '' }}">
                <datalist id="make-options">
                    {% for make in makes %}
                    <option value="{{ make }}"></option>
                    {% endfor %}
                </datalist>
            </div>
        </div>
        <div class="search-input-wrapper">
            <label for="model-input">Model</label>
            <div class="input-with-select input-compact">
                <i class="fas fa-cogs search-icon" aria-hidden="true"></i>
                <input id="model-input" type="text" name="model" class="search-input compact-input" placeholder="Select or type model" list="model-options" autocomplete="off" value="{{ selected_filters.model or '' }}" data-selected-model="{{ selected_filters.model or '' }}">
                <datalist id="model-options">
                    {% for model in all_models %}
                    <option value="{{ model }}"></option>
                    {% endfor %}
                </datalist>
            </div>
        </div>
        <div class="search-input-wrapper">
            <label for="engine-filter">Engine Keyword</label>
            <input id="engine-filter" type="text" name="engine" placeholder="e.g., 2.0L, V6" value="{{ selected_filters.engine or '' }}" class="compact-input">
        </div>
        <div class="search-input-wrapper">
            <label for="mileage-unit">Mileage Unit</label>
            <input id="mileage-unit" type="text" name="mileage_unit" list="mileage-unit-options" placeholder="km or miles" value="{{ selected_filters.mileage_unit or '' }}" class="compact-input" autocomplete="off">
            <datalist id="mileage-unit-options">
                {% for value, label in mileage_unit_options %}
                <option value="{{ value }}" label="{{ label }}"></option>
                {% endfor %}
            </datalist>
        </div>
    </div>

    <div class="filter-grid">
        <div class="form-group">
            <label>Min Year</label>
            <input type="number" name="min_year" placeholder="2000" value="{{ selected_filters.min_year or '' }}" class="compact-input">
        </div>
        <div class="form-group">
            <label>Max Year</label>
            <input type="number" name="max_year" placeholder="2025" value="{{ selected_filters.max_year or '' }}" class="compact-input">
        </div>
        <div class="form-group">
            <label>Min Price</label>
            <input type="number" name="min_price" value="{{ selected_filters.min_price or '' }}" class="compact-input">
        </div>
        <div class="form-group">
            <label>Max Price</label>
            <input type="number" name="max_price" value="{{ selected_filters.max_price or '' }}" class="compact-input">
        </div>
        <div class="form-group">
            <label>Fuel Type</label>
            <input type="text" name="fuel_type" list="fuel-type-options" value="{{ selected_filters.fuel_type or '' }}" class="compact-input" autocomplete="off">
            <datalist id="fuel-type-options">
                {% for fuel in fuel_types %}
                <option value="{{ fuel }}"></option>
                {% endfor %}
            </datalist>
        </div>
        <div class="form-group">
            <label>Cylinders</label>
            <select name="engine_cylinders" class="form-select">
                <option value="">Any</option>
                {% for cyl in engine_cylinders_options %}
                <option value="{{ cyl }}" {% if selected_filters.engine_cylinders == cyl %}selected{% endif %}>{{ cyl }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Engine Size</label>
            <select name="engine_liters" class="form-select">
                <option value="">Any</option>
                {% for size in engine_liters_options %}
                <option value="{{ size }}" {% if selected_filters.engine_liters == size %}selected{% endif %}>{{ size }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label>Min Mileage</label>
            <input type="number" name="min_mileage" value="{{ selected_filters.min_mileage or '' }}" class="compact-input">
        </div>
        <div class="form-group">
            <label>Max Mileage</label>
            <input type="number" name="max_mileage" value="{{ selected_filters.max_mileage or '' }}" class="compact-input">
        </div>
        <div class="form-group">
            <label>Category</label>
            <input type="text" name="category" list="category-options" value="{{ selected_filters.category or '' }}" class="compact-input" autocomplete="off">
            <datalist id="category-options">
                {% for cat in categories %}
                <option value="{{ cat }}"></option>
                {% endfor %}
            </datalist>
        </div>
        <div class="form-group">
            <label>Gearbox</label>
            <input type="text" name="gearbox" list="gearbox-options" value="{{ selected_filters.gearbox or '' }}" class="compact-input" autocomplete="off">
            <datalist id="gearbox-options">
                {% for option in gearbox_options %}
                <option value="{{ option }}"></option>
                {% endfor %}
            </datalist>
        </div>
        <div class="form-group">
            <label>Steering</label>
            <div class="chip-group compact-chips">
                {% for option in steering_options %}
                <label class="chip micro-chip">
                    <input type="checkbox" name="steering" value="{{ option }}" {% if selected_filters.steering and option in selected_filters.steering %}checked{% endif %}>
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="form-group">
            <label>Drive Wheels</label>
            <div class="chip-group compact-chips">
                {% for option in drive_options %}
                <label class="chip micro-chip">
                    <input type="checkbox" name="drive" value="{{ option }}" {% if selected_filters.drive and option in selected_filters.drive %}checked{% endif %}>
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="form-group">
            <label>Doors</label>
            <div class="chip-group compact-chips">
                {% for option in door_options %}
                <label class="chip micro-chip">
                    <input type="checkbox" name="doors" value="{{ option }}" {% if selected_filters.doors and option in selected_filters.doors %}checked{% endif %}>
                    <span>{{ option }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="form-group">
            <label>Tech Inspection</label>
            <input type="text" name="tech_inspection" list="inspection-options" value="{{ selected_filters.tech_inspection or '' }}" class="compact-input" autocomplete="off">
            <datalist id="inspection-options">
                <option value="Yes"></option>
                <option value="No"></option>
            </datalist>
        </div>
        <div class="form-group">
            <label>Catalyst</label>
            <input type="text" name="catalyst" list="catalyst-options" value="{{ selected_filters.catalyst or '' }}" class="compact-input" autocomplete="off">
            <datalist id="catalyst-options">
                <option value="Yes"></option>
                <option value="No"></option>
            </datalist>
        </div>
        <div class="form-group full-width">
            <label>Additional Functions</label>
            <div class="features-grid compact">
                {% for feature in features_options %}
                <label class="chip micro-chip">
                    <input type="checkbox" name="features" value="{{ feature }}" {% if selected_filters.features and feature in selected_filters.features %}checked{% endif %}>
                    <span>{{ feature }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
        <div class="form-group full-width">
            <label>Car Color</label>
            <div class="multi-select-group">
                <select name="colors" multiple class="compact-input multi-select" size="4">
                    {% for color in color_options %}
                    <option value="{{ color }}" {% if selected_filters.colors and color in selected_filters.colors %}selected{% endif %}>{{ color }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label>Interior Material</label>
            <input type="text" name="interior_material" list="interior-material-options" value="{{ selected_filters.interior_material or '' }}" class="compact-input" autocomplete="off">
            <datalist id="interior-material-options">
                {% for material in interior_material_options %}
                <option value="{{ material }}"></option>
                {% endfor %}
            </datalist>
        </div>
        <div class="form-group full-width">
            <label>Interior Color</label>
            <div class="multi-select-group">
                <select name="interior_colors" multiple class="compact-input multi-select" size="4">
                    {% for interior_color in interior_color_options %}
                    <option value="{{ interior_color }}" {% if selected_filters.interior_colors and interior_color in selected_filters.interior_colors %}selected{% endif %}>{{ interior_color }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="filter-actions">
        <button type="submit" class="btn-modern btn-primary btn-compact">
            <i class="fas fa-filter" aria-hidden="true"></i>
            Apply Filters
        </button>
        <a href="/search" class="btn-modern btn-outline btn-compact">
            <i class="fas fa-redo" aria-hidden="true"></i>
            Reset
        </a>
    </div>
</form>

<!-- Search Results Section -->
<section class="results-section" aria-label="Search results">
    <div class="results-header">
        <h2>
            <i class="fas fa-list" aria-hidden="true"></i>
            Search Results
        </h2>
        <span class="results-count">{{ cars|length }} car{% if cars|length != 1 %}s{% endif %} found</span>
    </div>
    
    {% if cars %}
    <div class="cars-grid">
        {% for car in cars %}
        <article class="car-card-modern" itemscope itemtype="https://schema.org/Car">
            <div class="car-image-wrapper">
                {% if car.get_images() %}
                <img 
                    src="{{ url_for('static', filename=car.get_images()[0]) }}" 
                    alt="{{ car.make }} {{ car.model }} {{ car.year }}" 
                    class="car-image"
                    loading="lazy"
                    itemprop="image">
                {% else %}
                <div class="car-image-placeholder">
                    <i class="fas fa-car" aria-hidden="true"></i>
                </div>
                {% endif %}
                
                <span class="car-badge">
                    <i class="fas fa-check-circle" aria-hidden="true"></i> Verified
                </span>
                
                {% if current_user.is_authenticated %}
                <button class="car-favorite {% if current_user.has_favorited(car) %}active{% endif %}" data-car-id="{{ car.id }}" aria-label="Toggle favorite" title="Toggle favorite">
                    <i class="{% if current_user.has_favorited(car) %}fas{% else %}far{% endif %} fa-heart" aria-hidden="true"></i>
                </button>
                {% endif %}
            </div>
            
            <div class="car-content">
                <h3 class="car-title" itemprop="name">
                    {{ car.make }} {{ car.model }}
                    <span class="car-year">{{ car.year }}</span>
                </h3>
                
                <div class="car-price" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                    <span itemprop="price">${{ "{:,.0f}".format(car.price) }}</span>
                    <meta itemprop="priceCurrency" content="USD">
                </div>
                
                <div class="car-specs">
                    {% if car.engine %}
                    <span class="spec-item" title="Engine">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        {{ car.engine }}
                    </span>
                    {% endif %}
                    {% if car.mileage %}
                    <span class="spec-item" title="Mileage">
                        <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                        {{ "{:,.0f}".format(car.mileage) }} km
                    </span>
                    {% endif %}
                    {% if car.gearbox %}
                    <span class="spec-item" title="Transmission">
                        <i class="fas fa-cogs" aria-hidden="true"></i>
                        {{ car.gearbox }}
                    </span>
                    {% endif %}
                </div>
                
                {% if car.description %}
                <p class="car-description">{{ car.description[:100] }}{% if car.description|length > 100 %}...{% endif %}</p>
                {% endif %}
                
                <div class="car-card-metrics">
                    <span title="Views"><i class="fas fa-eye" aria-hidden="true"></i> {{ car.views or 0 }}</span>
                    <span title="Favorites"><i class="fas fa-heart" aria-hidden="true"></i> {{ car.favorites_count }}</span>
                    {% if car.contact_number %}
                    <span title="Contact"><i class="fas fa-phone" aria-hidden="true"></i> {{ car.contact_number }}</span>
                    {% endif %}
                </div>
                <a href="/car/{{ car.id }}" class="btn-modern btn-primary" aria-label="View details for {{ car.make }} {{ car.model }}">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    View Details
                </a>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state-modern">
        <div class="empty-icon">
            <i class="fas fa-search" aria-hidden="true"></i>
        </div>
        <h2>No Cars Found</h2>
        <p>We couldn't find any cars matching your criteria. Try adjusting your filters or search terms.</p>
        <a href="/search" class="btn-modern btn-outline">
            <i class="fas fa-redo" aria-hidden="true"></i>
            Reset Filters
        </a>
    </div>
    {% endif %}
</section>

<!-- Favorite Button Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const favoriteButtons = document.querySelectorAll('.car-favorite');
    
    favoriteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const carId = this.dataset.carId;
            const icon = this.querySelector('i');
            
            fetch(`/toggle_favorite/${carId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.favorited) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    this.classList.add('active');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    this.classList.remove('active');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update favorites. Please try again.');
            });
        });
    });
});
</script>

{% endblock %}
