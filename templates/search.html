{% extends 'base.html' %}
{% block title %}Search Cars - AutoSolo{% endblock %}
{% block content %}

<!-- Search Page Header -->
<div class="page-header">
    <h1>
        <i class="fas fa-search" aria-hidden="true"></i>
        Search Your Perfect Car
    </h1>
    <p>Use our advanced filters to find exactly what you're looking for</p>
</div>

<!-- Enhanced Search Form -->
<form class="search-form" method="POST" role="search">
    <div class="search-input-wrapper">
        <i class="fas fa-car search-icon" aria-hidden="true"></i>
        <input type="text" name="make" placeholder="Enter car make (e.g., Toyota, BMW)" value="{{ selected_filters.make or '' }}" class="search-input">
    </div>
    
    <div class="search-input-wrapper">
        <i class="fas fa-cogs search-icon" aria-hidden="true"></i>
        <input type="text" name="model" placeholder="Enter car model (e.g., Camry, X5)" value="{{ selected_filters.model or '' }}" class="search-input">
    </div>
    
    <details>
        <summary>
            <i class="fas fa-sliders-h" aria-hidden="true"></i>
            Advanced Filters
        </summary>
        <div class="filter-grid">
            <!-- Year -->
            <div class="form-group">
                <label>Min Year</label>
                <input type="number" name="min_year" placeholder="2000" value="{{ selected_filters.min_year or '' }}">
            </div>
            <div class="form-group">
                <label>Max Year</label>
                <input type="number" name="max_year" placeholder="2025" value="{{ selected_filters.max_year or '' }}">
            </div>
            <!-- Price -->
            <div class="form-group">
                <label>Min Price</label>
                <input type="number" name="min_price" value="{{ selected_filters.min_price or '' }}">
            </div>
            <div class="form-group">
                <label>Max Price</label>
                <input type="number" name="max_price" value="{{ selected_filters.max_price or '' }}">
            </div>
            <!-- Engine -->
            <div class="form-group">
                <label>Engine</label>
                <input type="text" name="engine" placeholder="e.g., 2.0L" value="{{ selected_filters.engine or '' }}">
            </div>
            <!-- Mileage -->
            <div class="form-group">
                <label>Min Mileage</label>
                <input type="number" name="min_mileage" value="{{ selected_filters.min_mileage or '' }}">
            </div>
            <div class="form-group">
                <label>Max Mileage</label>
                <input type="number" name="max_mileage" value="{{ selected_filters.max_mileage or '' }}">
            </div>
            <!-- Category -->
            <div class="form-group">
                <label>Category</label>
                <select name="category">
                    <option value="">Any</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if selected_filters.category == cat %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Gearbox -->
            <div class="form-group">
                <label>Gearbox</label>
                <select name="gearbox">
                    <option value="">Any</option>
                    {% for option in gearbox_options %}
                    <option value="{{ option }}" {% if selected_filters.gearbox == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Steering -->
            <div class="form-group">
                <label>Steering</label>
                <div>
                    {% for option in steering_options %}
                    <label><input type="checkbox" name="steering" value="{{ option }}" {% if selected_filters.steering and option in selected_filters.steering %}checked{% endif %}> {{ option }}</label>
                    {% endfor %}
                </div>
            </div>
            <!-- Drive -->
            <div class="form-group">
                <label>Drive Wheels</label>
                <div>
                    {% for option in drive_options %}
                    <label><input type="checkbox" name="drive" value="{{ option }}" {% if selected_filters.drive and option in selected_filters.drive %}checked{% endif %}> {{ option }}</label>
                    {% endfor %}
                </div>
            </div>
            <!-- Doors -->
            <div class="form-group">
                <label>Doors</label>
                <div>
                    {% for option in door_options %}
                    <label><input type="checkbox" name="doors" value="{{ option }}" {% if selected_filters.doors and option in selected_filters.doors %}checked{% endif %}> {{ option }}</label>
                    {% endfor %}
                </div>
            </div>
            <!-- Tech Inspection -->
            <div class="form-group">
                <label>Tech Inspection</label>
                <select name="tech_inspection">
                    <option value="">Any</option>
                    <option value="Yes" {% if selected_filters.tech_inspection == 'Yes' %}selected{% endif %}>Yes</option>
                    <option value="No" {% if selected_filters.tech_inspection == 'No' %}selected{% endif %}>No</option>
                </select>
            <!-- Catalyst -->
            <div class="form-group">
                <label>Catalyst</label>
                <select name="catalyst">
                    <option value="">Any</option>
                    {% for option in catalyst_options %}
                    <option value="{{ option }}" {% if selected_filters.catalyst == option %}selected{% endif %}>{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Fuel Type -->
            <div class="form-group">
                <label>Fuel Type</label>
                <select name="fuel_type">
                    <option value="">Any</option>
                    {% for fuel in fuel_types %}
                    <option value="{{ fuel }}" {% if selected_filters.fuel_type == fuel %}selected{% endif %}>{{ fuel }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Features -->
            <div class="form-group full-width">
                <label>Additional Functions</label>
                <div class="features-grid">
                    {% for feature in features_options %}
                    <label><input type="checkbox" name="features" value="{{ feature }}" {% if selected_filters.features and feature in selected_filters.features %}checked{% endif %}> {{ feature }}</label>
                    {% endfor %}
                </div>
            </div>
            <!-- Colors -->
            <div class="form-group full-width">
                <label>Car Color</label>
                <select name="colors" multiple>
                    {% for color in color_options %}
                    <option value="{{ color }}" {% if selected_filters.colors and color in selected_filters.colors %}selected{% endif %}>{{ color }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Interior Material -->
            <div class="form-group">
                <label>Interior Material</label>
                <select name="interior_material">
                    <option value="">Any</option>
                    {% for material in interior_material_options %}
                    <option value="{{ material }}" {% if selected_filters.interior_material == material %}selected{% endif %}>{{ material }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Interior Colors -->
            <div class="form-group full-width">
                <label>Interior Color</label>
                <select name="interior_colors" multiple>
                    {% for interior_color in interior_color_options %}
                    <option value="{{ interior_color }}" {% if selected_filters.interior_colors and interior_color in selected_filters.interior_colors %}selected{% endif %}>{{ interior_color }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </details>
    <button type="submit" class="btn-modern btn-primary btn-large">
        Apply Filters
    </button>
</form>

<!-- Search Results Section -->
<section class="results-section" aria-label="Search results">
    <div class="results-header">
        <h2>
            <i class="fas fa-list" aria-hidden="true"></i>
            Search Results
        </h2>
        <span class="results-count">{{ cars|length }} car{% if cars|length != 1 %}s{% endif %} found</span>
    </div>
    
    {% if cars %}
    <div class="cars-grid">
        {% for car in cars %}
        <article class="car-card-modern" itemscope itemtype="https://schema.org/Car">
            <div class="car-image-wrapper">
                {% if car.get_images() %}
                <img 
                    src="{{ url_for('static', filename=car.get_images()[0]) }}" 
                    alt="{{ car.make }} {{ car.model }} {{ car.year }}" 
                    class="car-image"
                    loading="lazy"
                    itemprop="image">
                {% else %}
                <div class="car-image-placeholder">
                    <i class="fas fa-car" aria-hidden="true"></i>
                </div>
                {% endif %}
                
                <span class="car-badge">
                    <i class="fas fa-check-circle" aria-hidden="true"></i> Verified
                </span>
                
                {% if current_user.is_authenticated %}
                <button class="car-favorite {% if current_user.has_favorited(car) %}active{% endif %}" data-car-id="{{ car.id }}" aria-label="Toggle favorite" title="Toggle favorite">
                    <i class="{% if current_user.has_favorited(car) %}fas{% else %}far{% endif %} fa-heart" aria-hidden="true"></i>
                </button>
                {% endif %}
            </div>
            
            <div class="car-content">
                <h3 class="car-title" itemprop="name">
                    {{ car.make }} {{ car.model }}
                    <span class="car-year">{{ car.year }}</span>
                </h3>
                
                <div class="car-price" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                    <span itemprop="price">${{ "{:,.0f}".format(car.price) }}</span>
                    <meta itemprop="priceCurrency" content="USD">
                </div>
                
                <div class="car-specs">
                    {% if car.engine %}
                    <span class="spec-item" title="Engine">
                        <i class="fas fa-cog" aria-hidden="true"></i>
                        {{ car.engine }}
                    </span>
                    {% endif %}
                    {% if car.mileage %}
                    <span class="spec-item" title="Mileage">
                        <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
                        {{ "{:,.0f}".format(car.mileage) }} km
                    </span>
                    {% endif %}
                    {% if car.gearbox %}
                    <span class="spec-item" title="Transmission">
                        <i class="fas fa-cogs" aria-hidden="true"></i>
                        {{ car.gearbox }}
                    </span>
                    {% endif %}
                </div>
                
                {% if car.description %}
                <p class="car-description">{{ car.description[:100] }}{% if car.description|length > 100 %}...{% endif %}</p>
                {% endif %}
                
                <div class="car-card-metrics">
                    <span title="Views"><i class="fas fa-eye" aria-hidden="true"></i> {{ car.views or 0 }}</span>
                    <span title="Favorites"><i class="fas fa-heart" aria-hidden="true"></i> {{ car.favorites_count }}</span>
                    {% if car.contact_number %}
                    <span title="Contact"><i class="fas fa-phone" aria-hidden="true"></i> {{ car.contact_number }}</span>
                    {% endif %}
                </div>
                <a href="/car/{{ car.id }}" class="btn-modern btn-primary" aria-label="View details for {{ car.make }} {{ car.model }}">
                    <i class="fas fa-info-circle" aria-hidden="true"></i>
                    View Details
                </a>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state-modern">
        <div class="empty-icon">
            <i class="fas fa-search" aria-hidden="true"></i>
        </div>
        <h2>No Cars Found</h2>
        <p>We couldn't find any cars matching your criteria. Try adjusting your filters or search terms.</p>
        <a href="/search" class="btn-modern btn-outline">
            <i class="fas fa-redo" aria-hidden="true"></i>
            Reset Filters
        </a>
    </div>
    {% endif %}
</section>

<!-- Favorite Button Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const favoriteButtons = document.querySelectorAll('.car-favorite');
    
    favoriteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const carId = this.dataset.carId;
            const icon = this.querySelector('i');
            
            fetch(`/toggle_favorite/${carId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.favorited) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    this.classList.add('active');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    this.classList.remove('active');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to update favorites. Please try again.');
            });
        });
    });
});
</script>

{% endblock %}